# 동시성

동시성 
- 둘 이상의 코드 조각이 실행될 때 동시에 실행중인 것처럼 행동하는 것
- 스레드, 프로세스, 파이버 등을 사용해서 코드의 다른 부분으로 실행을 전환할 수 있어야 한다.
병렬성 
- 실제로 동시에 실행되는 것
- 여러대의 컴퓨터 혹은 물리 코어로 동시에 일을 처리한다.

모든 일에 동시성이 있다.


## Topic 33 시간적 결합 꺠트리기

시간의 두 가지 측면 (시간과 관련해서 신경 써야 할)
- 동시성 (동시에 일어나는 일들)
- 순서 (시간의 흐름 속에서 일들의 상대적인 위치)

로직들 간의 시간 순서를 깨트려서 동시성을 확보해야 한다.
유연성, 작업 흐름 분석과 아키텍처, 설계, 배포와 같은 개발의 여러 측면에서 시간과 관련된 의존성도 같이 줄일 수 있다.

### 동시성 찾기

작업 흐름을 모델화 하고 분석하는 작업에서는 동시에 일어나도 되는 일, 그렇지 않은 일을 찾아내야 한다.
활동 다이어그램 (activity diagram) 같은 방법으로 작업 흐름을 기록하는 방법을 활용한다.

#### 활동 다이어그램
활동: 모서리가 둥근 상자
화살표: 화살표를 받은 활동은 이전 활동이 긑난 후 시작 가능하다.
동기화 막대: 동기화 막대로 들어오는 활동이 모두 완료된 후에애 막대에서 나가는 화살표를 따라 진행할 수 있다.
자이게에 오는 화살표가 없는 활동은 언제든지 시작할 수 있다.

동시에 진행할 수 있지만 진행하고 있지 않은 활동을 찾아 병렬성을 극대화 할 수 있따.

### 동시 작업의 기회

 동시 작업이 가능한 여러 작업이 발견될 경우, 그 작업들 내에서도 작업의 순서를 정하는 것이 의미가 있다.
 어떤 작업은 시간이 많이 걸리고 어떤 작업은 시간을 적게 소요한다. CPU를 쓰지않고 대기하는 작업도 있다.
 이런 작업들의 특성을 파악해서 동시에 처리가 가능하게 작업을 배치하면 조금 더 생산적이게 될 수 있다.

### 병렬 작업의 기회

 하나의 로직을 동시에 처리 가능한 여러 부분 작업들로 나누어 처리한 다음, 결과로 합칠 수 있다면 동시성과 병렬성을 최대한 활용할 수 있다.

### 기회를 찾아 내는 것은 쉽다.

 동시 작업으로 이득을 볼 수 있는 부분을 찾았으나, 어떻게 안전하게 구현할 수 있을까?


## TOPIC 34 공유 상태는 틀린 상태

자신이 보는 메모리에 있는 값이 틀린 값일 수 있다.
어덯게 원자적으로 값을 바꿀 수 있을까?

### 세마포어 및 다른 상호 배재 방법

 lock을 획득한 사람 만이 해당 공간의 작업에 대한 소유권을 가지는 방식.
 작업이 끝나면 lock을 반환해야 한다.
 만약 규칙이 지켜지지 않으면 커다란 장애로 이어질 수 있다.

### 리소스를 틀내잭션으로 관리하라
### 여러 리소스와 트랜잭션

### 트랜잭션이 없는 갱신

불규칙한 실패는 동시성이 문제인 경우가 많다.

### 그 밖의 독립적인 접근

뮤텍스, 세마포어, 모니터 라고 불리는 상호 배제를 도와주는 라이브러리가 대게의 언어에서 제공된다.

언어 자체가 동시성을 지원하는 경우도 있다. (Rust)

함수형 언어도 동시성 문제에서 안전하지 않을 수도...


### 데메테르 법칙 (Law of Demeter)

어떤 클래스 C에 정의된 메서드가 다움 목록에 속하는 것만 사용할 수 있다.
- C의 다른 인스턴스 메서드
- 메서드의 매게 변수
- 스택이나 힙에 자신이 생성하는 객체의 메서드
- 전역 변수

하지만 현실적으로 이 법칙을 사용하긴 어렵다.

### 의사 선생님 아파요...

의사 선생님。이렇게 하면 아파요
그러면 그렇게 하지 마세요

관련항목
- 항목 10. 직교성
- 항목 28. 결합도 줄이기
- 항목 38. 우연에 말기는 프로그래밍


## Topic 35 액터와 프로세스

액터: 자신만의 비공개 지역 상태state툴 가진 독립적인 가상 쳐리 장치
- 액터는 우편함을 보유하고 있다.
- 액터가 잠을자다 일어나면 우편함에 도착해 있는 우편을 처리한다.
- 한 우편에 대한 처리가 끝나면 남아 있는 다음 우편에 대한 처리를 한다.
- 우편이 비어 있으면 다시 잠든다.
- 메세지를 쳐리할 때 액터는 다른 액터를 생성하거나，알고 있는 다른 액 터에게 메시지를 보내거나，다른 메시지졸 쳐리할 때의 상태가 될 새로운 상태를 생성할 수 있다.
프로세스: 본래 더 일반적인 가상처리장치. 액터처럼만 동작하도록 제한적으로 만 사용할 수도 있다.

### 액터는 언제나 동시성을 띈다.

액터의 정의
- 액터를 관리하는 것은 아무것도 없다.
- 시스템이 저장하는 상태는 오직 메시지 그리고 각 액터의 지역 상태 뿐이다. 메세지는 수신자가 읽는 것 외에 확인할 수 있는 방법이 없다. 지역 상태는 액터 바깥에서 접근이 불가능하다.
- 모든 메세지는 일방향이다. 답장이란 개념은 없다.
- 액터는 각 메세지가 끝날 때까지 처리하고 중간에 다른 일을 하지 않는다.즉 한 번에 하나의 메세지만 처리한다.

액터들은 아무것드 공유하지 않으면서 비동기적으토 동시에 실행된다.


### 간단한 액터
### 드러나지 않는 동시성

액터 모델에서는 동시성을 다루는 코드를 쓸 필요가 없다. 공유된 상태가 없기 떄문이다.

### 얼랭이 장을 마련하다.

얼랭 언어와 런타임은 엑터 구조의 좋은 사례다.

얼랭-그리고 얼랭의 후손인 엘리서에안 엑터가 있는 것은 아니다. 다른 대부분의 언어에드 액터 구현이 있다. 동시에 실행되는 작업을 구현할 때는 엑터를 사용하라.


## Topic 36 칠판

점을 하나만 사용하도록 노력해라 (언제든지 사용하는 코드의 구현이 바뀔 수 있다.)

컴퓨팅 기반의 칠판 시스템: 자유방임주의적 동시성

- JavaSpaces나 T Spaces 같이 분산된 철판 : 객체뢰 데이터뿐만 아니라 자바 객체 전체를 칠판에 저장할 수 있고. 템플릿이나 와일드카드를 통한 필드의 부분 일치 검색 또는 유형별 검색으로 다시 불러올 수 있다

### 칠판 사용 사례

주택 담보 대출, 신용 대출

칠판 시스템을 법적 요구 사항을 캡슐화하는 규칙 엔진과 항께 사용하면 이러한 어려움올 우아하계 해결할 수 있다. 어떤 사실이 칠판에 올라가면 적절한 규칙이 발동되도록 하면 된다， 결과에 대한 피드백도 마찬가지로 쉽계 다룰 수 있다，어떤 규칙에서 나온 것이든 그 결과를 다시 칠판에 올려서 다른 규칙들이 발동하도록 하면 된다.

### 메시지 시스템과 칠판의 유사성

카프카나 NATS 같은 메시징 시스템
- 록히 이번트 로그의 형태로 영속성을 제공
- 패턴 매칭 형태로 메세지를 가져 오는 것도 지원한다.
- 메세징 시스템을 칠판 혹은 여러 액터를 실행하는 플렛폼으로 사용할 수도있다. (플렛폼으로써는 어떤 의미지???)

### 하지만 그렇게 간단하지 않다...

이런 접근 방식을 사용하면 많은 동작이 간접적으르 일어나므로 분석이 더 힘들다. (비용적인 관점)
메시지 형식 및 api를 모아두는 중앙 저장소를 운영하면 도움이 될 것이다.
이 저장소에서 코드나 문서까지 생성해준다면 더 좋다.
특정한 처리를 시작할 때 고유한 '추적id'를 만들어 붙이는 것도 좋다.
